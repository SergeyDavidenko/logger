name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.25

    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./...
      
    - name: Run benchmarks
      run: go test -bench=. -benchmem ./...
      
    - name: Check formatting
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Code is not formatted correctly"
          exit 1
        fi
        
    - name: Run go vet
      run: go vet ./...

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "Logger ${{ github.ref_name }}"
        body: |
          ## üöÄ Logger ${{ github.ref_name }} - Production Ready Release
          
          ### ‚ú® Features
          - High-performance Go logger with Logstash integration
          - Synchronous and asynchronous logging modes
          - Multiple log levels (DEBUG, INFO, WARN, ERROR, FATAL)
          - TCP/UDP protocol support for Logstash
          - Thread-safe operations with proper mutex synchronization
          - Custom timestamp formatting and function name capture
          - **Structured logging with `With()` method** - Add context fields to loggers
          
          ### üîí Security & Reliability
          - Race condition free - All concurrent access properly synchronized
          - Goroutine safe - No memory leaks or resource issues
          - Panic resistant - Proper error handling throughout
          - Production tested - **81.6% test coverage**
          - Zero-copy field access for optimal performance
          
          ### üìä Performance Benchmarks
          
          **Log a message and 10 fields:**
          - **670.2 ns/op** - Ranks 4th out of 10 tested loggers
          - **4 allocs/op** - 20% fewer allocations than original
          - **416 B/op** - Memory efficient
          - Faster than slog, zap (sugared), go-kit, log15, and logrus
          
          **Log a message with pre-configured context:**
          - **432.9 ns/op** - Ranks 7th out of 10 tested loggers
          - **3 allocs/op** - 40% fewer allocations than original
          - **272 B/op** - Ultra memory efficient
          - Comparable to apex/log (only 7% slower)
          
          *Benchmarks run on Go 1.25.0, macOS, Apple M3 Pro (12 cores), 18 GB RAM*
          
          ### üõ†Ô∏è Integration
          - ELK Stack ready - Elasticsearch, Logstash, Kibana
          - Go modules support
          - Docker examples included
          - CI/CD workflows provided
          
          ### üì¶ Installation
          ```bash
          go get github.com/SergeyDavidenko/logger@${{ github.ref_name }}
          ```
          
          Perfect for microservices, APIs, and high-load applications!
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
